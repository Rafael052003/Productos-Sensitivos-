<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grupo Riba Smith — R/S Chitré Selecto — Productos Sensitivos</title>
  <meta name="theme-color" content="#1f2937">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary-color: #111827;
      --secondary-color: #374151;
      --bg-light: #f4f5f7;
      --accent-green: #0A7456;
      --accent-red: #E34F4F;
      --highlight-yellow: #fff2b0;
      --highlight-green: #d4edda;
      --highlight-red: #f8d7da;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-light);
      color: var(--primary-color);
      padding: 20px;
    }
    .container { max-width: 960px; margin: 0 auto; }

    #splash {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--primary-color); color: #fff;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 9999; transition: opacity 0.5s ease-out;
    }
    #splash img { width: 120px; margin-bottom: 20px; }
    #splash h2 { font-weight: bold; font-size: 24px; margin-bottom: 10px; }
    #splash p { margin-top: 5px; font-size: 14px; opacity: 0.9; }

    header { text-align: center; margin-bottom: 24px; }
    .title-group { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
    .title-group h1 {
      font-size: 24px; font-weight: 700; margin: 2px 0;
      color: var(--primary-color); text-transform: uppercase;
    }
    @media (max-width: 600px) { .title-group h1 { font-size: 18px; } }

    .controls-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
    .actions {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-bottom: 20px;
    }
    .action-btn {
      background: var(--primary-color); color: white; border: 0;
      padding: 12px 24px; border-radius: 999px; cursor: pointer; font-weight: 600;
      transition: all 0.2s ease-in-out; display: flex; align-items: center; gap: 8px;
    }
    .action-btn:hover { background: var(--secondary-color); transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .action-btn.danger { background: var(--accent-red); }
    .action-btn.danger:hover { background: #dc2626; }
    .action-btn.green { background: var(--accent-green); }
    .action-btn.green:hover { background: #08664b; }

    .chips { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    .chip {
      padding: 8px 16px; border-radius: 999px; cursor: pointer;
      background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s ease-in-out; font-size: 14px;
    }
    .chip:hover { transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
    .chip.active { background: var(--primary-color); color: white; }

    .table-container { overflow-x: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-radius: 8px; }
    table {
      width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px;
      background: white; border-radius: 8px; overflow: hidden;
    }
    th, td { border: 1px solid #e5e7eb; padding: 12px; text-align: center; }
    th { background: #f3f4f6; font-weight: 600; white-space: nowrap; }
    td.left { text-align: left; }
    th.product-sensitive { white-space: normal; line-height: 1.2; }
    input[type="number"] {
      width: 100%; border: 0; text-align: center; background: transparent;
      font-size: 14px; padding: 2px; outline: none; transition: background-color 0.3s;
    }
    td[contenteditable="true"] { background: #fefce8; }

    .selected-row { background-color: #e0f7fa !important; }
    .initial-highlight { background-color: var(--highlight-yellow) !important; }
    .increased { background-color: var(--highlight-green) !important; }
    .decreased { background-color: var(--highlight-red) !important; }

    .toast-container {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      display: flex; flex-direction: column-reverse; gap: 10px; z-index: 1000;
    }
    .toast {
      padding: 12px 20px; border-radius: 8px; color: white; font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px);
      animation: slideIn 0.5s forwards;
    }
    .toast.success { background-color: var(--accent-green); }
    .toast.warning { background-color: #ff9800; }
    .toast.error { background-color: var(--accent-red); }
    @keyframes slideIn { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }
  </style>
</head>
<body>
  <div id="splash">
    <img src="icon-192.png" alt="Logo">
    <h2>PRODUCTOS SENSITIVOS</h2>
    <p>Powered by Rafael Ramos</p>
    <p>Versión 1.0</p>
  </div>

  <div class="container">
    <header>
      <div class="title-group">
        <h1>GRUPO RIBA SMITH</h1>
        <h1>R/S CHITRÉ SELECTO</h1>
        <h1>LISTADO DE PRODUCTOS SENSITIVOS</h1>
      </div>
    </header>

    <div class="controls-container">
      <div class="chips" id="chips"></div>
    </div>

    <div class="actions">
      <button id="btnAdd" class="action-btn"><i class="fas fa-plus"></i> Agregar Fila</button>
      <button id="btnExport" class="action-btn green"><i class="fas fa-file-pdf"></i> Generar PDF</button>
      <button id="btnClear" class="action-btn danger"><i class="fas fa-eraser"></i> Borrar Horarios</button>
      <button id="btnDeleteRow" class="action-btn danger"><i class="fas fa-trash-alt"></i> Eliminar Fila</button>
    </div>

    <div class="table-container">
      <table id="tabla">
        <thead>
          <tr>
            <th>PRECIO</th>
            <th class="left product-sensitive">PRODUCTO<br>SENSITIVO</th>
            <th>07:00</th>
            <th>12:00</th>
            <th>15:00</th>
            <th>22:00</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div id="toast" class="toast-container"></div>
  </div>

  <script>
    (function () {
      const DEFAULT_SECCIONES = ['PASILLO 6','MEDICAMENTOS','CAVA','PASTILLAS CANINAS','PASTILLO 1'];
      const STORAGE_KEY = 'productos_sensitivos_por_seccion';
      let productos = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      let seccionActiva = DEFAULT_SECCIONES[0];
      let insertIndex = null;
      let selectedRow = null;

      const tbody = document.getElementById('tbody');
      const chipsEl = document.getElementById('chips');
      const btnExport = document.getElementById('btnExport');
      const btnClear = document.getElementById('btnClear');
      const btnAdd = document.getElementById('btnAdd');
      const btnDeleteRow = document.getElementById('btnDeleteRow');
      const toastContainer = document.getElementById('toast');

      window.addEventListener("load", () => {
        setTimeout(() => { document.getElementById("splash").style.opacity = "0"; }, 1500);
        setTimeout(() => { document.getElementById("splash").style.display = "none"; }, 2000);
      });

      function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(productos)); }
      function showToast(msg,type='success'){
        const t=document.createElement('div');t.className=`toast ${type}`;t.textContent=msg;toastContainer.appendChild(t);
        setTimeout(()=>{t.style.opacity='0';t.style.transform='translateY(20px)';setTimeout(()=>t.remove(),500);},2000);
      }

      function renderChips(){
        chipsEl.innerHTML='';DEFAULT_SECCIONES.forEach(s=>{
          const b=document.createElement('div');
          b.className='chip'+(s===seccionActiva?' active':'');b.textContent=s;
          b.onclick=()=>{seccionActiva=s;render();};chipsEl.appendChild(b);
        });
      }

      function render(){
        renderChips();tbody.innerHTML='';selectedRow=null;insertIndex=null;
        const list=productos.filter(p=>p.seccion===seccionActiva);
        if(!list.length){tbody.innerHTML='<tr><td colspan=6 style="color:#666;text-align:center;padding:20px;">Sin productos en esta sección.</td></tr>';return;}
        list.forEach((p)=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td contenteditable="true" data-field="precio">${p.precio||''}</td>
            <td class="left" contenteditable="true" data-field="nombre">${p.nombre||''}</td>
            <td><input type="number" data-field="t0700" value="${p.t0700||''}"></td>
            <td><input type="number" data-field="t1200" value="${p.t1200||''}"></td>
            <td><input type="number" data-field="t1500" value="${p.t1500||''}"></td>
            <td><input type="number" data-field="t2200" value="${p.t2200||''}"></td>
          `;
          const inputs=tr.querySelectorAll('input[type="number"]');
          inputs.forEach(inp=>{
            inp.addEventListener('input',()=>{
              const idx=productos.indexOf(p);productos[idx][inp.dataset.field]=inp.value.trim();save();applyColorLogic(inp);
            });
          });
          tr.addEventListener('click',()=>{if(selectedRow)selectedRow.classList.remove('selected-row');selectedRow=tr;selectedRow.classList.add('selected-row');insertIndex=productos.indexOf(p);});
          tbody.appendChild(tr);
        });
      }

      function applyColorLogic(inp){
        const rowInputs=Array.from(inp.closest('tr').querySelectorAll('input'));
        const idx=rowInputs.indexOf(inp);
        const val=parseFloat(inp.value);const prevVal=idx>0?parseFloat(rowInputs[idx-1].value):NaN;
        inp.classList.remove('initial-highlight','increased','decreased');
        if(idx===0&&inp.value.trim()!==''){inp.classList.add('initial-highlight');}
        else if(!isNaN(val)&&!isNaN(prevVal)&&prevVal!==0){
          if(val<prevVal){inp.classList.add('decreased');showToast('¡Advertencia! Diferencia detectada.','warning');}
          else if(val>prevVal){inp.classList.add('increased');}
        }
      }

      btnAdd.onclick=()=>{const f={seccion:seccionActiva,precio:'',nombre:'',t0700:'',t1200:'',t1500:'',t2200:''};
        if(insertIndex!==null){productos.splice(insertIndex+1,0,f);showToast('Fila agregada.','success');}
        else{productos.push(f);showToast('Fila agregada al final.','success');}
        save();render();};

      btnDeleteRow.onclick=()=>{if(insertIndex!==null){if(confirm('¿Eliminar esta fila?')){productos.splice(insertIndex,1);save();render();showToast('Fila eliminada.','success');}}
        else{showToast('Selecciona una fila.','error');}};

      btnClear.onclick=()=>{if(confirm('¿Borrar horarios de la sección?')){productos=productos.map(p=>p.seccion===seccionActiva?{...p,t0700:'',t1200:'',t1500:'',t2200:''}:p);save();render();showToast('Horarios borrados.','success');}};
      
      btnExport.onclick=()=>{
        if(!productos.length){
            showToast('No hay productos para exportar.', 'warning');
            return;
        }

        const doc = new window.jspdf.jsPDF();
        const headers = [['PRECIO', 'PRODUCTO SENSITIVO', '07:00', '12:00', '15:00', '22:00']];
        const sections = ['PASILLO 6', 'MEDICAMENTOS', 'CAVA', 'PASTILLAS CANINAS', 'PASTILLO 1'];

        const centerX = doc.internal.pageSize.width / 2;
        const rightEdge = doc.internal.pageSize.width - 14;

        doc.setFontSize(16);
        doc.text('Grupo Riba Smith', centerX, 15, { align: 'center' });
        doc.text('R/S Chitré Selecto', centerX, 22, { align: 'center' });
        doc.text('Listado de Productos Sensitivos', centerX, 29, { align: 'center' });
        
        doc.setFontSize(10);
        doc.text(`Fecha de exportación: ${new Date().toLocaleDateString('es-ES')}`, rightEdge, 36, { align: 'right' });
        
        let finalY = 45;

        sections.forEach(seccion => {
            const list = productos.filter(p => p.seccion === seccion);
            
            if (list.length > 0) {
                doc.setFontSize(12);
                doc.text(seccion, centerX, finalY, { align: 'center' });
                finalY += 5;

                const tableBody = [];

                list.forEach(p => {
                    const row = [p.precio || '', p.nombre || '', p.t0700 || '', p.t1200 || '', p.t1500 || '', p.t2200 || ''];
                    tableBody.push(row);
                });

                const colStyles = {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 60, halign: 'left' },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 25 },
                    5: { cellWidth: 25 }
                };

                doc.autoTable({
                    head: headers,
                    body: tableBody,
                    startY: finalY,
                    theme: 'grid',
                    headStyles: { fillColor: [243, 244, 246], textColor: [17, 24, 39], fontStyle: 'bold' },
                    styles: { fontSize: 9, cellPadding: 3, textColor: [37, 41, 51] },
                    columnStyles: colStyles,
                    didDrawCell: data => {
                        if (data.section === 'body') {
                            const cell = data.cell;
                            const row = list[data.row.index];
                            const rowData = [row.t0700, row.t1200, row.t1500, row.t2200];
                            const colIndex = data.column.index - 2;

                            const colors = {
                                yellow: [255, 242, 176],
                                green: [212, 237, 218],
                                red: [248, 215, 218],
                            };

                            if (colIndex >= 0) {
                                const value = parseFloat(cell.text);
                                const prevValue = colIndex > 0 ? parseFloat(rowData[colIndex - 1]) : NaN;

                                if (colIndex === 0 && cell.text !== '') {
                                    doc.setFillColor(...colors.yellow);
                                    doc.rect(cell.x, cell.y, cell.width, cell.height, 'F');
                                } else if (!isNaN(value) && !isNaN(prevValue) && prevValue !== 0) {
                                    if (value > prevValue) {
                                        doc.setFillColor(...colors.green);
                                        doc.rect(cell.x, cell.y, cell.width, cell.height, 'F');
                                    } else if (value < prevValue) {
                                        doc.setFillColor(...colors.red);
                                        doc.rect(cell.x, cell.y, cell.width, cell.height, 'F');
                                    }
                                }
                            }
                        }
                    },
                    didDrawPage: (data) => {
                      doc.setFontSize(10);
                      doc.text('Powered by Rafael Ramos', doc.internal.pageSize.width - 15, doc.internal.pageSize.height - 10, null, null, 'right');
                    }
                });
                finalY = doc.autoTable.previous.finalY + 10;
            }
        });

        const blob = doc.output('blob');
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Listado_Productos_Sensitivos.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      render();
    })();
  </script>
</body>
</html>
