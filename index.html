<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grupo Riba Smith — R/S Chitré Selecto — Productos Sensitivos</title>
  <meta name="theme-color" content="#1f2937">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary-color: #111827;
      --secondary-color: #374151;
      --bg-light: #f4f5f7;
      --accent-green: #0A7456;
      --accent-red: #E34F4F;
      --highlight-yellow: #fff2b0;
      --highlight-green: #d4edda;
      --highlight-red: #f8d7da;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-light);
      color: var(--primary-color);
      padding: 20px;
    }
    .container { max-width: 960px; margin: 0 auto; }

    #splash {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--primary-color); color: #fff;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 9999; transition: opacity 0.5s ease-out;
    }
    #splash img { width: 120px; margin-bottom: 20px; }
    #splash h2 { font-weight: bold; font-size: 24px; margin-bottom: 10px; }
    #splash p { margin-top: 5px; font-size: 14px; opacity: 0.9; }

    header { text-align: center; margin-bottom: 24px; }
    .title-group { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
    .title-group h1 {
      font-size: 24px; font-weight: 700; margin: 2px 0;
      color: var(--primary-color); text-transform: uppercase;
    }
    @media (max-width: 600px) { .title-group h1 { font-size: 18px; } }

    .controls-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
    .actions {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-bottom: 20px;
    }
    .action-btn {
      background: var(--primary-color); color: white; border: 0;
      padding: 12px 24px; border-radius: 999px; cursor: pointer; font-weight: 600;
      transition: all 0.2s ease-in-out; display: flex; align-items: center; gap: 8px;
    }
    .action-btn:hover { background: var(--secondary-color); transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .action-btn.danger { background: var(--accent-red); }
    .action-btn.danger:hover { background: #dc2626; }
    .action-btn.green { background: var(--accent-green); }
    .action-btn.green:hover { background: #08664b; }

    .chips { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    .chip {
      padding: 8px 16px; border-radius: 999px; cursor: pointer;
      background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s ease-in-out; font-size: 14px;
    }
    .chip.active { background: var(--primary-color); color: white; }

    .table-container { overflow-x: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-radius: 8px; }
    table {
      width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px;
      background: white; border-radius: 8px; overflow: hidden;
    }
    th, td { border: 1px solid #e5e7eb; padding: 12px; text-align: center; }
    th { background: #f3f4f6; font-weight: 600; white-space: nowrap; }
    td.left { text-align: left; }
    th.product-sensitive { white-space: normal; line-height: 1.2; }
    input[type="number"] {
      width: 100%; border: 0; text-align: center; background: transparent;
      font-size: 14px; padding: 2px; outline: none; transition: background-color 0.3s;
    }
    td[contenteditable="true"] { background: #fefce8; }

    .selected-row { background-color: #e0f7fa !important; }
    .initial-highlight { background-color: var(--highlight-yellow) !important; }
    .increased { background-color: var(--highlight-green) !important; }
    .decreased { background-color: var(--highlight-red) !important; }

    .toast-container {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      display: flex; flex-direction: column-reverse; gap: 10px; z-index: 1000;
    }
    .toast {
      padding: 12px 20px; border-radius: 8px; color: white; font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px);
      animation: slideIn 0.5s forwards;
    }
    .toast.success { background-color: var(--accent-green); }
    .toast.warning { background-color: #ff9800; }
    .toast.error { background-color: var(--accent-red); }
    @keyframes slideIn { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }

    /* Estilos para el PDF/Impresión */
    @media print {
      @page { margin: 10mm; }
      body { padding: 0; font-family: 'Poppins', sans-serif; font-size: 12pt; }
      .container, header, .controls, .chips { display: none; }
      .printable-content { display: block !important; }
      .page-break { page-break-before: always; }

      .pdf-header { text-align: center; margin-bottom: 20px; }
      .pdf-header h1 { font-size: 20pt; margin: 2px 0; font-weight: 700; text-transform: uppercase; }
      .pdf-header p { 
        font-size: 16pt; /* Más grande */
        font-weight: bold; /* Negrita */
        margin-top: 5px; 
        text-align: center; 
      }

      .pdf-section-title { text-align: center; font-size: 16pt; font-weight: 700; margin-top: 20px; text-transform: uppercase;}

      table { border-collapse: collapse; margin-top: 10px; font-size: 12pt; table-layout: fixed; margin-left: auto; margin-right: auto; width: 90%; }
      th, td { border: 1px solid #333; padding: 8px; text-align: center; }
      th { background: #f0f0f0; font-weight: bold; }

      .initial-highlight { background-color: #fff2b0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .increased { background-color: #d4edda !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .decreased { background-color: #f8d7da !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

      .pdf-footer {
        position: fixed;
        bottom: 20px;
        width: 100%;
        text-align: center;
        font-size: 16pt; /* Más grande */
        font-weight: bold; /* Negrita */
        color: #666;
      }
      .page-break { page-break-before: always; }
      .print-btn { display:none; }

      /* Anchos de columna y alineación para el PDF */
      table th:nth-child(1), table td:nth-child(1){ width: 10%; } /* PRECIO */
      table th:nth-child(2), table td:nth-child(2){ width: 30%; text-align: center; } /* PRODUCTO SENSITIVO - CENTRADO */
      table th:nth-child(3), table td:nth-child(3){ width: 15%; } /* 07:00 */
      table th:nth-child(4), table td:nth-child(4){ width: 15%; } /* 12:00 */
      table th:nth-child(5), table td:nth-child(5){ width: 15%; } /* 15:00 */
      table th:nth-child(6), table td:nth-child(6){ width: 15%; } /* 22:00 */

      .product-sensitive-header{
        white-space: normal;
        line-height: 1.2;
      }
    }
  </style>
</head>
<body>
  <div id="splash">
    <img src="icon-192.png" alt="Logo">
    <h2>PRODUCTOS SENSITIVOS</h2>
    <p>Powered by Rafael Ramos</p>
    <p>Versión 1.0</p>
  </div>

  <div class="container">
    <header>
      <div class="title-group">
        <h1>GRUPO RIBA SMITH</h1>
        <h1>R/S CHITRÉ SELECTO</h1>
        <h1>LISTADO DE PRODUCTOS SENSITIVOS</h1>
      </div>
    </header>

    <div class="controls-container">
      <div class="chips" id="chips"></div>
    </div>

    <div class="actions">
      <button id="btnAdd" class="action-btn"><i class="fas fa-plus"></i> Agregar Fila</button>
      <button id="btnExport" class="action-btn green"><i class="fas fa-file-pdf"></i> Generar PDF</button>
      <button id="btnClear" class="action-btn danger"><i class="fas fa-eraser"></i> Borrar Horarios</button>
      <button id="btnDeleteRow" class="action-btn danger"><i class="fas fa-trash-alt"></i> Eliminar Fila</button>
    </div>

    <div class="table-container">
      <table id="tabla">
        <thead>
          <tr>
            <th>PRECIO</th>
            <th class="left product-sensitive">PRODUCTO<br>SENSITIVO</th>
            <th>07:00</th>
            <th>12:00</th>
            <th>15:00</th>
            <th>22:00</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div id="toast" class="toast-container"></div>
  </div>

  <script>
    (function () {
      const DEFAULT_SECCIONES = ['PASILLO 6','MEDICAMENTOS','CAVA','PASTILLAS CANINAS','PASTILLO 1'];
      const STORAGE_KEY = 'productos_sensitivos_por_seccion';
      let productos = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      let seccionActiva = DEFAULT_SECCIONES[0];
      let insertIndex = null;
      let selectedRow = null;

      const tbody = document.getElementById('tbody');
      const chipsEl = document.getElementById('chips');
      const btnExport = document.getElementById('btnExport');
      const btnClear = document.getElementById('btnClear');
      const btnAdd = document.getElementById('btnAdd');
      const btnDeleteRow = document.getElementById('btnDeleteRow');
      const toastContainer = document.getElementById('toast');

      window.addEventListener("load", () => {
        setTimeout(() => { document.getElementById("splash").style.opacity = "0"; }, 1500);
        setTimeout(() => { document.getElementById("splash").style.display = "none"; }, 2000);
      });

      function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(productos)); }
      function showToast(msg,type='success'){
        const t=document.createElement('div');t.className=`toast ${type}`;t.textContent=msg;toastContainer.appendChild(t);
        setTimeout(()=>{t.style.opacity='0';t.style.transform='translateY(20px)';setTimeout(()=>t.remove(),500);},2000);
      }

      function renderChips(){
        chipsEl.innerHTML='';DEFAULT_SECCIONES.forEach(s=>{
          const b=document.createElement('div');
          b.className='chip'+(s===seccionActiva?' active':'');b.textContent=s;
          b.onclick=()=>{seccionActiva=s;render();};chipsEl.appendChild(b);
        });
      }

      function render(){
        renderChips();tbody.innerHTML='';selectedRow=null;insertIndex=null;
        const list=productos.filter(p=>p.seccion===seccionActiva);
        if(!list.length){tbody.innerHTML='<tr><td colspan=6 style="color:#666;text-align:center;padding:20px;">Sin productos en esta sección.</td></tr>';return;}
        list.forEach((p)=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td contenteditable="true" data-field="precio">${p.precio||''}</td>
            <td class="left" contenteditable="true" data-field="nombre">${p.nombre||''}</td>
            <td><input type="number" data-field="t0700" value="${p.t0700||''}"></td>
            <td><input type="number" data-field="t1200" value="${p.t1200||''}"></td>
            <td><input type="number" data-field="t1500" value="${p.t1500||''}"></td>
            <td><input type="number" data-field="t2200" value="${p.t2200||''}"></td>
          `;
          
          tr.querySelectorAll('[contenteditable="true"]').forEach(td=>{
            td.addEventListener('input',()=>{
              const field=td.dataset.field;
              const index=productos.indexOf(p);
              productos[index][field]=td.innerText.trim();
              save();
            });
          });
          
          const applyColorAndAlertLogic = (targetInput) => {
              const currentRowInputs = Array.from(targetInput.closest('tr').querySelectorAll('input[type="number"]'));
              const currentIndex = currentRowInputs.indexOf(targetInput);
              
              const currentValue = parseFloat(targetInput.value);
              const prevInput = currentRowInputs[currentIndex - 1];
              const prevValue = prevInput ? parseFloat(prevInput.value) : -1;

              targetInput.classList.remove('initial-highlight', 'increased', 'decreased');

              if (currentIndex === 0 && targetInput.value.trim() !== '') {
                  targetInput.classList.add('initial-highlight');
              } else if (!isNaN(currentValue) && !isNaN(prevValue) && prevValue !== -1 && prevValue !== 0) {
                  if (currentValue < prevValue) {
                      targetInput.classList.add('decreased');
                      showToast('¡Advertencia! Diferencia detectada.','warning');
                  } else if (currentValue > prevValue) {
                      targetInput.classList.add('increased');
                  }
              }
          };

          tr.querySelectorAll('input[type="number"]').forEach((inp, idx) => {
            applyColorAndAlertLogic(inp);

            inp.addEventListener('input', () => {
              const index = productos.indexOf(p);
              const field = inp.dataset.field;
              const newValue = inp.value.trim();

              productos[index][field] = newValue;
              save();

              applyColorAndAlertLogic(inp);

              const currentRowInputs = Array.from(inp.closest('tr').querySelectorAll('input[type="number"]'));
              const currentIndex = currentRowInputs.indexOf(inp);
              for (let j = currentIndex + 1; j < currentRowInputs.length; j++) {
                  applyColorAndAlertLogic(currentRowInputs[j]);
              }
            });
          });
          
          tr.addEventListener('click',()=>{if(selectedRow)selectedRow.classList.remove('selected-row');selectedRow=tr;selectedRow.classList.add('selected-row');insertIndex=productos.indexOf(p);});
          tbody.appendChild(tr);
        });
      }

      btnAdd.onclick=()=>{const f={seccion:seccionActiva,precio:'',nombre:'',t0700:'',t1200:'',t1500:'',t2200:''};
        if(insertIndex!==null){productos.splice(insertIndex+1,0,f);showToast('Fila agregada.','success');}
        else{productos.push(f);showToast('Fila agregada al final.','success');}
        save();render();};

      btnDeleteRow.onclick=()=>{if(insertIndex!==null){if(confirm('¿Eliminar esta fila?')){productos.splice(insertIndex,1);save();render();showToast('Fila eliminada.','success');}}
        else{showToast('Selecciona una fila.','error');}};

      btnClear.onclick=()=>{if(confirm('¿Borrar horarios de la sección?')){productos=productos.map(p=>p.seccion===seccionActiva?{...p,t0700:'',t1200:'',t1500:'',t2200:''}:p);save();render();showToast('Horarios borrados.','success');}};

      btnExport.onclick=()=>{
        if(!productos.length){showToast('No hay productos para exportar.', 'warning');return;}

        const getPdfCellClass = (currentValue, prevValue, isFirstColumn) => {
            const numCurrent = parseFloat(currentValue);
            const numPrev = parseFloat(prevValue);

            if (isFirstColumn && currentValue.trim() !== '') {
                return 'initial-highlight';
            } else if (!isNaN(numCurrent) && !isNaN(numPrev) && prevValue !== '') {
                if (numCurrent < numPrev) {
                    return 'decreased';
                } else if (currentValue > prevValue) {
                    return 'increased';
                }
            }
            return '';
        };

        let html = `<html><head><meta charset='utf-8'><title>Productos Sensitivos</title>
        <style>
          body{font-family:'Poppins', sans-serif; margin:0; padding:0;}
          
          /* Estilos para el PDF/Impresión */
          .printable-content { padding: 40px 30px; }
          .pdf-header { text-align: center; margin-bottom: 20px; }
          .pdf-header h1 { font-size: 20pt; margin: 2px 0; font-weight: 700; text-transform: uppercase; }
          .pdf-header p { 
            font-size: 16pt; 
            font-weight: bold; 
            margin-top: 5px; 
            text-align: center; 
          }

          .pdf-section-title { text-align: center; font-size: 16pt; font-weight: 700; margin-top: 20px; text-transform: uppercase;}

          table { border-collapse: collapse; margin-top: 10px; font-size: 12pt; table-layout: fixed; margin-left: auto; margin-right: auto; width: 90%; }
          th, td { border: 1px solid #333; padding: 8px; text-align: center; }
          th { background: #f0f0f0; font-weight: bold; }

          .initial-highlight { background-color: #fff2b0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          .increased { background-color: #d4edda !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          .decreased { background-color: #f8d7da !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

          .pdf-footer {
            position: fixed;
            bottom: 20px;
            width: 100%;
            text-align: center;
            font-size: 16pt; 
            font-weight: bold; 
            color: #666;
          }
          .page-break { page-break-before: always; }
          .print-btn { display:none; }

          /* Anchos de columna y alineación para el PDF */
          table th:nth-child(1), table td:nth-child(1){ width: 10%; } /* PRECIO */
          table th:nth-child(2), table td:nth-child(2){ width: 30%; text-align: center; } /* PRODUCTO SENSITIVO - CENTRADO */
          table th:nth-child(3), table td:nth-child(3){ width: 15%; } /* 07:00 */
          table th:nth-child(4), table td:nth-child(4){ width: 15%; } /* 12:00 */
          table th:nth-child(5), table td:nth-child(5){ width: 15%; } /* 15:00 */
          table th:nth-child(6), table td:nth-child(6){ width: 15%; } /* 22:00 */

          .product-sensitive-header{
            white-space: normal;
            line-height: 1.2;
          }
        </style></head><body>`;
        
        html += `<div class="printable-content">`;
        html += `<div class="pdf-header">`;
        html += `<h1>GRUPO RIBA SMITH</h1>`;
        html += `<h1>R/S CHITRÉ SELECTO</h1>`;
        html += `<h1>LISTADO DE PRODUCTOS SENSITIVOS</h1>`;
        html += `<p>Fecha de exportación: ${new Date().toLocaleDateString('es-ES')}</p>`;
        html += `</div>`;

        const secciones = ['PASILLO 6', 'MEDICAMENTOS', 'CAVA', 'PASTILLAS CANINAS', 'PASTILLO 1'];

        secciones.forEach((sec, index) => {
            const rows = productos.filter(p => p.seccion === sec);
            if (rows.length) {
                if (index > 0) {
                    html += `<div class="page-break"></div>`;
                }
                html += `<div class="pdf-section-title">${sec}</div>`;
                html += `<table><thead><tr><th>PRECIO</th><th class="product-sensitive-header">PRODUCTO<br>SENSITIVO</th><th>07:00</th><th>12:00</th><th>15:00</th><th>22:00</th></tr></thead><tbody>`;
                rows.forEach(r => {
                    let t0700_val = r.t0700 || '';
                    let t1200_val = r.t1200 || '';
                    let t1500_val = r.t1500 || '';
                    let t2200_val = r.t2200 || '';

                    // Recalcular las clases de color para el PDF basándose en los valores
                    let class0700 = getPdfCellClass(t0700_val, '', true); 
                    let class1200 = getPdfCellClass(t1200_val, t0700_val, false);
                    let class1500 = getPdfCellClass(t1500_val, t1200_val, false);
                    let class2200 = getPdfCellClass(t2200_val, t1500_val, false);
                    
                    html += `<tr>
                        <td>${r.precio||''}</td>
                        <td class="product-sensitive-header" style="text-align: center;">${r.nombre||''}</td>
                        <td class="${class0700}">${t0700_val}</td>
                        <td class="${class1200}">${t1200_val}</td>
                        <td class="${class1500}">${t1500_val}</td>
                        <td class="${class2200}">${t2200_val}</td>
                    </tr>`;
                });
                html += `</tbody></table>`;
            }
        });
        
        html += `<div class="pdf-footer">Powered by Rafael Ramos</div>`;
        html += `<button class='print-btn' onclick='window.print()'>Guardar como PDF</button>`;
        html += `</div>`;
        html += `</body></html>`;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => printWindow.print(), 1000);
      };
      
      render();
    })();
  </script>
</body>
</html>
